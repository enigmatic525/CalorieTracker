<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI Calorie Tracker</title>
    <link rel="manifest" href="manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        neutral: {
                            850: '#1f1f1f',
                            900: '#171717',
                            950: '#0a0a0a',
                        }
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body { 
            font-family: 'Inter', sans-serif; 
            -webkit-tap-highlight-color: transparent; 
            font-size: 14px;
        }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        
        input[type="text"], input[type="number"] { 
            cursor: text !important; 
            -webkit-user-select: text !important;
            user-select: text !important;
            font-weight: 400;
            font-size: 14px !important;
        }
        .header-text { font-weight: 700; }
        
        * {
            letter-spacing: 0px !important;
        }
        
        .tab-active {
            color: #fbbf24;
            border-bottom: 2px solid #fbbf24;
        }
        .tab-inactive {
            color: #737373;
            border-bottom: 2px solid transparent;
        }
        .tab-inactive:hover { color: #a3a3a3; }
    </style>
</head>
<body class="bg-neutral-950 text-neutral-100 pb-24 selection:bg-amber-500/30">
    <div id="app" class="max-w-4xl mx-auto p-4 md:p-8 space-y-8">
        
        <!-- Goal Modal -->
        <div id="goal-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
            <div class="bg-neutral-900 border border-neutral-800 p-6 rounded-xl w-full max-w-sm shadow-2xl">
                <h3 class="header-text text-lg mb-4 text-white">Set Daily Goal</h3>
                <input id="goal-input" type="number" class="w-full bg-neutral-800 border border-neutral-700 rounded-lg p-3 text-white mb-6 outline-none focus:ring-2 focus:ring-amber-500 placeholder-neutral-500" placeholder="e.g. 2000">
                <div class="flex gap-3">
                    <button onclick="closeGoalModal()" class="flex-1 py-3 rounded-lg font-bold text-neutral-400 hover:bg-neutral-800 transition-colors">Cancel</button>
                    <button onclick="saveGoalFromModal()" class="flex-1 py-3 rounded-lg font-bold bg-amber-500 text-black hover:bg-amber-400 transition-colors">Save</button>
                </div>
            </div>
        </div>

        <!-- Log Modal -->
        <div id="log-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
            <div class="bg-neutral-900 border border-neutral-800 p-6 rounded-xl w-full max-w-sm shadow-2xl space-y-5">
                <div class="flex justify-between items-center border-b border-neutral-800 pb-2">
                    <h3 class="header-text text-lg text-white">Log Item</h3>
                    <div class="flex gap-4">
                        <button onclick="setModalMode('daily')" id="modal-tab-daily" class="tab-active pb-1 text-xs header-text uppercase tracking-widest transition-all">Daily</button>
                        <button onclick="setModalMode('library')" id="modal-tab-library" class="tab-inactive pb-1 text-xs header-text uppercase tracking-widest transition-all">Library</button>
                    </div>
                </div>
                
                <div class="space-y-4">
                    <div class="relative flex items-center group">
                        <div class="absolute left-3 z-10 pointer-events-none transition-colors duration-300">
                            <svg id="modal-search-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-neutral-500 group-focus-within:text-amber-500"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
                            <svg id="modal-loading-spinner" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="hidden animate-spin text-amber-500"><line x1="12" y1="2" x2="12" y2="6"/><line x1="12" y1="18" x2="12" y2="22"/><line x1="4.93" y1="4.93" x2="7.76" y2="7.76"/><line x1="16.24" y1="16.24" x2="19.07" y2="19.07"/><line x1="2" y1="12" x2="6" y2="12"/><line x1="18" y1="12" x2="22" y2="12"/><line x1="4.93" y1="19.07" x2="7.76" y2="16.24"/><line x1="16.24" y1="7.76" x2="19.07" y2="4.93"/></svg>
                        </div>
                        <input 
                            id="modal-food-input"
                            type="text"
                            inputmode="text"
                            enterkeyhint="go"
                            placeholder="Describe food or enter calories..."
                            class="w-full bg-neutral-800 border border-neutral-700 rounded-lg py-3 pl-10 pr-4 text-white outline-none focus:ring-2 focus:ring-amber-500 placeholder-neutral-500 transition-all"
                        >
                    </div>
                    <p id="modal-error-msg" class="hidden text-rose-400 font-bold text-xs px-1"></p>

                    <div class="flex gap-3">
                        <button onclick="closeLogModal()" class="flex-1 py-3 rounded-lg font-bold text-neutral-400 hover:bg-neutral-800 transition-colors">Cancel</button>
                        <button onclick="handleModalLog()" class="flex-1 py-3 rounded-lg font-bold bg-amber-500 text-black hover:bg-amber-400 transition-colors">Log</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Dashboard Header -->
        <header class="space-y-6">
            <div class="bg-neutral-900/50 backdrop-blur-sm p-6 rounded-xl border border-neutral-800 shadow-2xl">
                <div id="totals-grid" class="flex flex-col md:flex-row gap-6 items-start md:items-center w-full">
                    <!-- Stats injected here -->
                </div>
            </div>

            <!-- Goal Progress Section -->
            <div class="bg-neutral-900 p-6 rounded-xl border border-neutral-800 shadow-xl">
                <div class="flex justify-between items-end mb-3">
                    <h2 class="header-text text-neutral-500 text-xs uppercase tracking-widest">Daily Progress</h2>
                    <button onclick="editGoal()" class="text-xs text-amber-500 hover:text-amber-400 header-text uppercase tracking-widest transition-colors cursor-pointer outline-none">
                        Goal: <span id="goal-display">2000</span>
                    </button>
                </div>
                <div class="w-full bg-neutral-800 rounded-full h-3 overflow-hidden">
                    <div id="progress-bar" class="bg-amber-500 h-full rounded-full transition-all duration-500 ease-out" style="width: 0%"></div>
                </div>
                <div class="mt-2 text-[10px] text-neutral-500 font-bold">
                    <span id="percent-display">0%</span>
                </div>
            </div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <div class="lg:col-span-2 space-y-6">
                <!-- Input Section -->
                <section class="bg-neutral-900 p-6 rounded-xl border border-neutral-800 shadow-xl space-y-4">
                    <div class="flex items-center gap-6 border-b border-neutral-800 pb-1">
                        <button onclick="setMainMode('daily')" id="tab-daily" class="tab-active pb-2 header-text transition-all">
                            Log to Daily
                        </button>
                        <button onclick="setMainMode('library')" id="tab-library" class="tab-inactive pb-2 header-text transition-all">
                            Save to Library
                        </button>
                    </div>

                    <!-- Main Dashboard Form -->
                    <form onsubmit="handleMainLog(event)" class="relative flex items-center group">
                        <div class="absolute left-1 z-10 pointer-events-none transition-colors duration-300">
                            <svg id="main-search-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-neutral-500 group-focus-within:text-amber-500"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
                            <svg id="main-loading-spinner" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="hidden animate-spin text-amber-500"><line x1="12" y1="2" x2="12" y2="6"/><line x1="12" y1="18" x2="12" y2="22"/><line x1="4.93" y1="4.93" x2="7.76" y2="7.76"/><line x1="16.24" y1="16.24" x2="19.07" y2="19.07"/><line x1="2" y1="12" x2="6" y2="12"/><line x1="18" y1="12" x2="22" y2="12"/><line x1="4.93" y1="19.07" x2="7.76" y2="16.24"/><line x1="16.24" y1="7.76" x2="19.07" y2="4.93"/></svg>
                        </div>
                        <input 
                            id="food-input"
                            type="text"
                            inputmode="text"
                            enterkeyhint="send"
                            placeholder="Describe food or enter calories..."
                            class="relative z-20 w-full bg-neutral-850 border border-transparent focus:border-neutral-700 rounded-lg py-4 pl-5 pr-20 outline-none focus:ring-2 focus:ring-amber-500/50 transition-all block text-white placeholder-neutral-600"
                        >
                        <button type="submit" class="absolute right-2 z-30 bg-neutral-800 hover:bg-neutral-700 text-amber-500 font-bold py-2 px-4 rounded-md transition-colors border border-neutral-700 min-h-[40px]">
                            Log
                        </button>
                    </form>
                    <p id="error-msg" class="hidden mt-3 text-rose-400 font-bold px-2"></p>
                </section>

                <!-- Daily Log -->
                <section class="bg-neutral-900 rounded-xl border border-neutral-800 overflow-hidden shadow-lg">
                    <div class="p-6 border-b border-neutral-800 bg-neutral-900/50">
                        <h2 class="header-text flex items-center gap-2 text-neutral-500">Today's Log</h2>
                    </div>
                    <div id="log-container" class="divide-y divide-neutral-800 max-h-[500px] overflow-y-auto no-scrollbar">
                    </div>
                </section>
            </div>

            <!-- Library Section -->
            <aside class="bg-neutral-900 rounded-xl border border-neutral-800 h-fit overflow-hidden shadow-lg">
                <div class="p-6 border-b border-neutral-800 bg-neutral-900/50 header-text text-neutral-500">Library</div>
                <div id="library-container" class="p-2 space-y-1 max-h-[500px] overflow-y-auto no-scrollbar">
                </div>
            </aside>
        </div>
    </div>

    <script>
        const apiKey = ""; 
        const modelName = "gemini-2.5-flash-preview-09-2025";
        let dailyLog = [];
        let savedItems = [];
        let dailyGoal = 2000;
        let mainInputMode = 'daily';
        let modalInputMode = 'daily';
        let lastResetDate = "";

        const elements = {
            mainInput: document.getElementById('food-input'),
            mainSearchIcon: document.getElementById('main-search-icon'),
            mainSpinner: document.getElementById('main-loading-spinner'),
            mainError: document.getElementById('error-msg'),
            
            modalInput: document.getElementById('modal-food-input'),
            modalSearchIcon: document.getElementById('modal-search-icon'),
            modalSpinner: document.getElementById('modal-loading-spinner'),
            modalError: document.getElementById('modal-error-msg'),
            logModal: document.getElementById('log-modal'),
            
            log: document.getElementById('log-container'),
            library: document.getElementById('library-container'),
            stats: document.getElementById('totals-grid'),
            
            goalDisplay: document.getElementById('goal-display'),
            progressBar: document.getElementById('progress-bar'),
            percentDisplay: document.getElementById('percent-display'),
            goalModal: document.getElementById('goal-modal'),
            goalInput: document.getElementById('goal-input'),
            
            tabDaily: document.getElementById('tab-daily'),
            tabLibrary: document.getElementById('tab-library'),
            modalTabDaily: document.getElementById('modal-tab-daily'),
            modalTabLibrary: document.getElementById('modal-tab-library')
        };

        function init() {
            const data = JSON.parse(localStorage.getItem('calorie_tracker_data') || '{"log":[],"library":[],"goal":2000,"lastResetDate":""}');
            const today = new Date().toDateString();

            if (data.lastResetDate !== today) {
                dailyLog = [];
                lastResetDate = today;
                localStorage.setItem('calorie_tracker_data', JSON.stringify({ ...data, log: [], lastResetDate: today }));
            } else {
                dailyLog = data.log || [];
                lastResetDate = data.lastResetDate;
            }

            savedItems = data.library || [];
            dailyGoal = data.goal || 2000;
            
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('./sw.js').catch(() => {});
            }
            render();
        }

        // --- Core Logic ---

        function handleMainLog(e) {
            e.preventDefault();
            const text = elements.mainInput.value.trim();
            if (!text) return;
            elements.mainInput.blur();
            processEntry(text, mainInputMode, 'main');
        }

        function handleModalLog() {
            const text = elements.modalInput.value.trim();
            if (!text) return;
            processEntry(text, modalInputMode, 'modal');
        }

        async function processEntry(text, mode, source) {
            setLoading(true, source);
            
            // Check if numeric
            const numeric = parseFloat(text);
            if (!isNaN(numeric) && isFinite(text)) {
                const item = { name: "Manual Entry", calories: numeric, protein: 0, carbs: 0, fat: 0 };
                finalizeItem(item, mode, source);
                return;
            }

            // Call AI
            try {
                const response = await fetchWithRetry(`https://generativelanguage.googleapis.com/v1beta/models/${modelName}:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text }] }],
                        systemInstruction: { parts: [{ text: 'Return JSON: {"name":string, "calories":number, "protein":number, "carbs":number, "fat":number}.' }] },
                        generationConfig: { responseMimeType: "application/json" }
                    })
                });
                const data = await response.json();
                const result = JSON.parse(data.candidates[0].content.parts[0].text);
                finalizeItem(result, mode, source);
            } catch (err) {
                showError(source, "Error: Could not analyze food. Check network.");
                setLoading(false, source);
            }
        }

        function finalizeItem(item, mode, source) {
            if (mode === 'daily') addLogItem(item);
            else addLibraryItem(item);
            
            setLoading(false, source);
            
            if (source === 'main') {
                elements.mainInput.value = "";
            } else {
                elements.modalInput.value = "";
                closeLogModal();
            }
        }

        async function fetchWithRetry(url, options, retries = 3, delay = 1000) {
            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (response.ok) return response;
                    if (response.status >= 400 && response.status < 500) throw new Error("Client Error");
                } catch (e) {
                    if (i === retries - 1) throw e;
                }
                await new Promise(res => setTimeout(res, delay));
            }
            throw new Error('Timeout');
        }

        // --- UI State Management ---

        function setLoading(isLoading, source) {
            const spinner = source === 'main' ? elements.mainSpinner : elements.modalSpinner;
            const icon = source === 'main' ? elements.mainSearchIcon : elements.modalSearchIcon;
            const error = source === 'main' ? elements.mainError : elements.modalError;
            
            spinner.classList.toggle('hidden', !isLoading);
            icon.classList.toggle('hidden', isLoading);
            if(isLoading) error.classList.add('hidden');
        }

        function showError(source, msg) {
            const error = source === 'main' ? elements.mainError : elements.modalError;
            error.textContent = msg;
            error.classList.remove('hidden');
        }

        function setMainMode(mode) {
            mainInputMode = mode;
            elements.tabDaily.className = mode === 'daily' ? 'tab-active pb-2 header-text' : 'tab-inactive pb-2 header-text';
            elements.tabLibrary.className = mode === 'library' ? 'tab-active pb-2 header-text' : 'tab-inactive pb-2 header-text';
            elements.mainInput.placeholder = mode === 'daily' ? "Describe food or enter calories..." : "Item to save...";
        }

        function setModalMode(mode) {
            modalInputMode = mode;
            elements.modalTabDaily.className = mode === 'daily' ? 'tab-active pb-1 text-xs header-text uppercase tracking-widest' : 'tab-inactive pb-1 text-xs header-text uppercase tracking-widest';
            elements.modalTabLibrary.className = mode === 'library' ? 'tab-active pb-1 text-xs header-text uppercase tracking-widest' : 'tab-inactive pb-1 text-xs header-text uppercase tracking-widest';
            elements.modalInput.placeholder = mode === 'daily' ? "Describe food or enter calories..." : "Item to save...";
        }

        function openLogModal() {
            elements.logModal.classList.remove('hidden');
            elements.modalInput.value = "";
            elements.modalError.classList.add('hidden');
            setTimeout(() => elements.modalInput.focus(), 100);
        }

        function closeLogModal() {
            elements.logModal.classList.add('hidden');
        }

        function editGoal() {
            elements.goalModal.classList.remove('hidden');
            elements.goalInput.value = dailyGoal;
            setTimeout(() => elements.goalInput.focus(), 100);
        }

        function closeGoalModal() {
            elements.goalModal.classList.add('hidden');
        }

        // --- Data Management ---

        function addLogItem(item) {
            dailyLog.unshift({ ...item, id: Date.now() });
            saveAndRender();
        }

        function addLibraryItem(item) {
            if (!savedItems.find(s => s.name.toLowerCase() === item.name.toLowerCase())) {
                savedItems.unshift({ ...item, id: Date.now() });
            }
            saveAndRender();
        }

        function deleteLog(id) {
            dailyLog = dailyLog.filter(i => i.id !== id);
            saveAndRender();
        }

        function deleteLibrary(id) {
            savedItems = savedItems.filter(i => i.id !== id);
            saveAndRender();
        }

        function saveGoalFromModal() {
            const newGoal = parseInt(elements.goalInput.value);
            if (!isNaN(newGoal) && newGoal > 0) {
                dailyGoal = newGoal;
                saveAndRender();
                closeGoalModal();
            }
        }

        function saveAndRender() {
            localStorage.setItem('calorie_tracker_data', JSON.stringify({ 
                log: dailyLog, 
                library: savedItems, 
                goal: dailyGoal,
                lastResetDate: lastResetDate 
            }));
            render();
        }

        function render() {
            const totals = dailyLog.reduce((a, b) => ({
                cal: a.cal + b.calories,
                p: a.p + b.protein,
                c: a.c + b.carbs,
                f: a.f + b.fat
            }), { cal: 0, p: 0, c: 0, f: 0 });

            elements.goalDisplay.textContent = dailyGoal;
            const percent = Math.min((totals.cal / dailyGoal) * 100, 100);
            elements.progressBar.style.width = `${percent}%`;
            elements.percentDisplay.textContent = `${Math.round(percent)}%`;

            elements.stats.innerHTML = `
                <div class="flex-1 border-b md:border-b-0 md:border-r border-neutral-800 pb-4 md:pb-0 pr-0 md:pr-8">
                    <span class="header-text text-neutral-500 text-[11px] uppercase tracking-widest">Total Calories</span>
                    <div class="header-text text-amber-500 text-4xl mt-1 leading-none">${Math.round(totals.cal)}<span class="ml-1 opacity-50 text-neutral-400 font-normal text-xs uppercase">kcal</span></div>
                </div>
                <div class="flex flex-1 flex-wrap gap-8 w-full">
                    ${statCard('Protein', Math.round(totals.p), 'g', 'text-red-500')}
                    ${statCard('Carbs', Math.round(totals.c), 'g', 'text-green-500')}
                    ${statCard('Fat', Math.round(totals.f), 'g', 'text-yellow-500')}
                </div>
            `;

            elements.log.innerHTML = dailyLog.map(item => `
                <div class="p-4 flex items-center justify-between hover:bg-neutral-800/50 transition-colors">
                    <div>
                        <h3 class="header-text text-white capitalize">${item.name}</h3>
                        <p class="text-neutral-500 mt-0.5">${item.calories} kcal • P: ${item.protein}g • C: ${item.carbs}g • F: ${item.fat}g</p>
                    </div>
                    <button onclick="deleteLog(${item.id})" class="p-2 text-neutral-600 hover:text-rose-400 min-h-[44px] min-w-[44px] flex items-center justify-center">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg>
                    </button>
                </div>
            `).join('');

            elements.library.innerHTML = savedItems.map(item => `
                <div class="p-3 rounded-lg hover:bg-neutral-800 flex items-center justify-between">
                    <div class="flex-1" onclick="addLogItem({name:'${item.name.replace(/'/g, "\\'")}',calories:${item.calories},protein:${item.protein},carbs:${item.carbs},fat:${item.fat}})">
                        <p class="header-text capitalize text-neutral-200">${item.name}</p>
                        <p class="text-neutral-500">${item.calories} kcal</p>
                    </div>
                    <div class="flex gap-1">
                        <button onclick="addLogItem({name:'${item.name.replace(/'/g, "\\'")}',calories:${item.calories},protein:${item.protein},carbs:${item.carbs},fat:${item.fat}})" class="p-2 text-neutral-600 hover:text-amber-500 min-h-[44px] min-w-[44px] flex items-center justify-center">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                        </button>
                        <button onclick="deleteLibrary(${item.id})" class="p-2 text-neutral-600 hover:text-rose-400 min-h-[44px] min-w-[44px] flex items-center justify-center">
                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function statCard(label, val, unit, colorClass) {
            return `<div class="flex flex-col"><span class="header-text text-neutral-500 text-[10px] uppercase tracking-widest">${label}</span><div class="header-text ${colorClass} mt-1">${val}<span class="ml-0.5 opacity-50 text-neutral-400 font-normal text-[10px]">${unit}</span></div></div>`;
        }

        // Modal Input Enter Key
        elements.modalInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') handleModalLog();
        });
        
        elements.goalInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') saveGoalFromModal();
        });

        init();
    </script>
</body>
</html>
