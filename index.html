<script>
    // ---------------------------------------------------------
    // CONFIGURATION
    // ---------------------------------------------------------
    // Get a free key at: https://aistudio.google.com/app/apikey
    const apiKey = ""; 
    const modelName = "gemini-2.0-flash";
    // ---------------------------------------------------------

    let dailyLog = [];
    let savedItems = [];
    let dailyGoal = 2000;
    let inputMode = 'daily';
    let lastResetDate = "";

    const elements = {
        logModal: document.getElementById('log-modal'),
        modalInput: document.getElementById('modal-food-input'),
        modalTabDaily: document.getElementById('modal-tab-daily'),
        modalTabLibrary: document.getElementById('modal-tab-library'),
        modalError: document.getElementById('modal-error-msg'),
        spinner: document.getElementById('loading-spinner'),
        searchIcon: document.getElementById('search-icon'),
        
        log: document.getElementById('log-container'),
        library: document.getElementById('library-container'),
        stats: document.getElementById('totals-grid'),
        
        goalDisplay: document.getElementById('goal-display'),
        progressBar: document.getElementById('progress-bar'),
        percentDisplay: document.getElementById('percent-display'),
        goalModal: document.getElementById('goal-modal'),
        goalInput: document.getElementById('goal-input')
    };

    function init() {
        const data = JSON.parse(localStorage.getItem('calorie_tracker_data') || '{"log":[],"library":[],"goal":2000,"lastResetDate":""}');
        const today = new Date().toDateString();

        if (data.lastResetDate !== today) {
            dailyLog = [];
            lastResetDate = today;
            localStorage.setItem('calorie_tracker_data', JSON.stringify({
                ...data,
                log: [],
                lastResetDate: today
            }));
        } else {
            dailyLog = data.log || [];
            lastResetDate = data.lastResetDate;
        }

        savedItems = data.library || [];
        dailyGoal = data.goal || 2000;
        
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('./sw.js').catch(() => {});
        }
        render();
    }

    // --- UI Modes ---

    function openLogModal() {
        elements.logModal.classList.remove('hidden');
        elements.modalInput.value = "";
        elements.modalError.classList.add('hidden');
        setTimeout(() => elements.modalInput.focus(), 100);
    }

    function closeLogModal() {
        elements.logModal.classList.add('hidden');
    }

    function setInputMode(mode) {
        inputMode = mode;
        elements.modalTabDaily.className = mode === 'daily' ? 'tab-active pb-1 text-xs header-text uppercase tracking-widest transition-all' : 'tab-inactive pb-1 text-xs header-text uppercase tracking-widest transition-all';
        elements.modalTabLibrary.className = mode === 'library' ? 'tab-active pb-1 text-xs header-text uppercase tracking-widest transition-all' : 'tab-inactive pb-1 text-xs header-text uppercase tracking-widest transition-all';
        elements.modalInput.placeholder = mode === 'daily' ? "Describe food or enter calories..." : "Item to save...";
        elements.modalInput.focus();
    }

    // --- Goal Logic ---

    function editGoal() {
        elements.goalModal.classList.remove('hidden');
        elements.goalInput.value = dailyGoal;
        setTimeout(() => elements.goalInput.focus(), 100);
    }

    function closeGoalModal() {
        elements.goalModal.classList.add('hidden');
    }

    function saveGoalFromModal() {
        const newGoal = parseInt(elements.goalInput.value);
        if (!isNaN(newGoal) && newGoal > 0) {
            dailyGoal = newGoal;
            saveAndRender();
            closeGoalModal();
        }
    }

    // --- Analysis Logic ---

    async function analyzeFood() {
        const text = elements.modalInput.value.trim();
        if (!text) return;

        // 1. Handle direct numbers
        const numeric = parseFloat(text);
        if (!isNaN(numeric) && isFinite(text)) {
            const item = { name: "Manual Entry", calories: numeric, protein: 0, carbs: 0, fat: 0 };
            finalizeItem(item);
            return;
        }

        setLoading(true);

        try {
            // 2. SIMULATION MODE (If no API Key)
            if (!apiKey) {
                console.warn("No API Key provided. Using Simulation Mode.");
                await new Promise(r => setTimeout(r, 800)); // Fake network delay
                
                // Mock logic for testing
                const mockItem = {
                    name: text,
                    calories: Math.floor(Math.random() * 400) + 100,
                    protein: Math.floor(Math.random() * 30),
                    carbs: Math.floor(Math.random() * 50),
                    fat: Math.floor(Math.random() * 15)
                };
                
                // Add a visual indicator that this is mock data
                mockItem.name += " (Simulated)";
                finalizeItem(mockItem);
                return;
            }

            // 3. REAL AI MODE
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${modelName}:generateContent?key=${apiKey}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    contents: [{ parts: [{ text: `Analyze this food: "${text}". Return ONLY valid JSON (no markdown) with keys: name (string), calories (number), protein (number), carbs (number), fat (number). Estimate standard portion if not specified.` }] }],
                    generationConfig: { responseMimeType: "application/json" }
                })
            });

            if (!response.ok) throw new Error("API Error");

            const data = await response.json();
            const result = JSON.parse(data.candidates[0].content.parts[0].text);
            finalizeItem(result);

        } catch (err) {
            console.error(err);
            elements.modalError.textContent = "Error: Could not analyze. Check API Key.";
            elements.modalError.classList.remove('hidden');
        } finally {
            setLoading(false);
        }
    }

    function finalizeItem(item) {
        if (inputMode === 'daily') addLogItem(item);
        else addLibraryItem(item);
        closeLogModal();
    }

    function addLogItem(item) {
        dailyLog.unshift({ ...item, id: Date.now() });
        saveAndRender();
    }

    function addLibraryItem(item) {
        // Prevent duplicate saves
        if (!savedItems.find(s => s.name.toLowerCase() === item.name.toLowerCase())) {
            savedItems.unshift({ ...item, id: Date.now() });
        }
        saveAndRender();
    }

    function deleteLog(id) {
        dailyLog = dailyLog.filter(i => i.id !== id);
        saveAndRender();
    }

    function deleteLibrary(id) {
        savedItems = savedItems.filter(i => i.id !== id);
        saveAndRender();
    }

    function saveAndRender() {
        localStorage.setItem('calorie_tracker_data', JSON.stringify({ 
            log: dailyLog, 
            library: savedItems, 
            goal: dailyGoal,
            lastResetDate: lastResetDate 
        }));
        render();
    }

    function setLoading(val) {
        elements.spinner.classList.toggle('hidden', !val);
        elements.searchIcon.classList.toggle('hidden', val);
        elements.modalError.classList.add('hidden');
    }

    function render() {
        const totals = dailyLog.reduce((a, b) => ({
            cal: a.cal + (b.calories || 0),
            p: a.p + (b.protein || 0),
            c: a.c + (b.carbs || 0),
            f: a.f + (b.fat || 0)
        }), { cal: 0, p: 0, c: 0, f: 0 });

        elements.goalDisplay.textContent = dailyGoal;
        const percent = dailyGoal > 0 ? Math.min((totals.cal / dailyGoal) * 100, 100) : 0;
        elements.progressBar.style.width = `${percent}%`;
        elements.percentDisplay.textContent = `${Math.round(percent)}%`;

        elements.stats.innerHTML = `
            <div class="flex-1 border-b md:border-b-0 md:border-r border-neutral-800 pb-4 md:pb-0 pr-0 md:pr-8">
                <span class="header-text text-neutral-500 text-[11px] uppercase tracking-widest">Total Calories</span>
                <div class="header-text text-amber-500 text-4xl mt-1 leading-none">${Math.round(totals.cal)}<span class="ml-1 opacity-50 text-neutral-400 font-normal text-xs uppercase">kcal</span></div>
            </div>
            <div class="flex flex-1 flex-wrap gap-8 w-full">
                ${statCard('Protein', Math.round(totals.p), 'g', 'text-red-500')}
                ${statCard('Carbs', Math.round(totals.c), 'g', 'text-green-500')}
                ${statCard('Fat', Math.round(totals.f), 'g', 'text-yellow-500')}
            </div>
        `;

        elements.log.innerHTML = dailyLog.length ? dailyLog.map(item => `
            <div class="p-4 flex items-center justify-between hover:bg-neutral-800/50 transition-colors">
                <div>
                    <h3 class="header-text text-white capitalize">${item.name}</h3>
                    <p class="text-neutral-500 mt-0.5">${item.calories} kcal • P: ${item.protein}g • C: ${item.carbs}g • F: ${item.fat}g</p>
                </div>
                <button onclick="deleteLog(${item.id})" class="p-2 text-neutral-600 hover:text-rose-400 min-h-[44px] min-w-[44px] flex items-center justify-center">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg>
                </button>
            </div>
        `).join('') : '<div class="p-6 text-neutral-600 text-center text-sm">No entries today</div>';

        elements.library.innerHTML = savedItems.length ? savedItems.map(item => `
            <div class="p-3 rounded-lg hover:bg-neutral-800 flex items-center justify-between group">
                <div class="flex-1 cursor-pointer" onclick="addLogItem({name:'${item.name.replace(/'/g, "\\'")}',calories:${item.calories},protein:${item.protein},carbs:${item.carbs},fat:${item.fat}})">
                    <p class="header-text capitalize text-neutral-200 group-hover:text-amber-500 transition-colors">${item.name}</p>
                    <p class="text-neutral-500 text-xs">${item.calories} kcal</p>
                </div>
                <div class="flex gap-1">
                    <button onclick="addLogItem({name:'${item.name.replace(/'/g, "\\'")}',calories:${item.calories},protein:${item.protein},carbs:${item.carbs},fat:${item.fat}})" class="p-2 text-neutral-600 hover:text-amber-500 min-h-[44px] min-w-[44px] flex items-center justify-center">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                    </button>
                    <button onclick="deleteLibrary(${item.id})" class="p-2 text-neutral-600 hover:text-rose-400 min-h-[44px] min-w-[44px] flex items-center justify-center">
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
                    </button>
                </div>
            </div>
        `).join('') : '<div class="p-2 text-neutral-600 text-center text-xs">Library empty</div>';
    }

    function statCard(label, val, unit, colorClass) {
        return `<div class="flex flex-col"><span class="header-text text-neutral-500 text-[10px] uppercase tracking-widest">${label}</span><div class="header-text ${colorClass} mt-1">${val}<span class="ml-0.5 opacity-50 text-neutral-400 font-normal text-[10px]">${unit}</span></div></div>`;
    }

    elements.modalInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') analyzeFood();
    });
    
    elements.goalInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') saveGoalFromModal();
    });

    init();
</script>
