<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI Calorie Tracker</title>
    <link rel="manifest" href="manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        neutral: {
                            850: '#1f1f1f',
                            900: '#171717',
                            950: '#0a0a0a',
                        }
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body { 
            font-family: 'Inter', sans-serif; 
            -webkit-tap-highlight-color: transparent; 
            font-size: 14px;
        }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        
        input[type="text"], input[type="number"] { 
            cursor: text !important; 
            -webkit-user-select: text !important;
            user-select: text !important;
            font-weight: 400;
            font-size: 14px !important;
        }
        .header-text { font-weight: 700; }
        
        * {
            letter-spacing: 0px !important;
        }
        
        .tab-active {
            color: #fbbf24;
            border-bottom: 2px solid #fbbf24;
        }
        .tab-inactive {
            color: #737373;
            border-bottom: 2px solid transparent;
        }
        .tab-inactive:hover { color: #a3a3a3; }
    </style>
</head>
<body class="bg-neutral-950 text-neutral-100 pb-24 selection:bg-amber-500/30">
    <div id="app" class="max-w-4xl mx-auto p-4 md:p-8 space-y-8">
        
        <div id="goal-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
            <div class="bg-neutral-900 border border-neutral-800 p-6 rounded-xl w-full max-w-sm shadow-2xl">
                <h3 class="header-text text-lg mb-4 text-white">Set Daily Goal</h3>
                <input id="goal-input" type="number" class="w-full bg-neutral-800 border border-neutral-700 rounded-lg p-3 text-white mb-6 outline-none focus:ring-2 focus:ring-amber-500 placeholder-neutral-500" placeholder="e.g. 2000">
                <div class="flex gap-3">
                    <button onclick="closeGoalModal()" class="flex-1 py-3 rounded-lg font-bold text-neutral-400 hover:bg-neutral-800 transition-colors">Cancel</button>
                    <button onclick="saveGoalFromModal()" class="flex-1 py-3 rounded-lg font-bold bg-amber-500 text-black hover:bg-amber-400 transition-colors">Save</button>
                </div>
            </div>
        </div>

        <div id="log-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
            <div class="bg-neutral-900 border border-neutral-800 p-6 rounded-xl w-full max-w-sm shadow-2xl space-y-5">
                <div class="flex justify-between items-center border-b border-neutral-800 pb-2">
                    <h3 class="header-text text-lg text-white">Log Item</h3>
                    <div class="flex gap-4">
                        <button onclick="setInputMode('daily')" id="modal-tab-daily" class="tab-active pb-1 text-xs header-text uppercase tracking-widest transition-all">Daily</button>
                        <button onclick="setInputMode('library')" id="modal-tab-library" class="tab-inactive pb-1 text-xs header-text uppercase tracking-widest transition-all">Library</button>
                    </div>
                </div>
                
                <div class="space-y-4">
                    <div class="relative flex items-center group">
                        <div class="absolute left-3 z-10 pointer-events-none transition-colors duration-300">
                            <svg id="search-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-neutral-500 group-focus-within:text-amber-500"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
                            <svg id="loading-spinner" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="hidden animate-spin text-amber-500"><line x1="12" y1="2" x2="12" y2="6"/><line x1="12" y1="18" x2="12" y2="22"/><line x1="4.93" y1="4.93" x2="7.76" y2="7.76"/><line x1="16.24" y1="16.24" x2="19.07" y2="19.07"/><line x1="2" y1="12" x2="6" y2="12"/><line x1="18" y1="12" x2="22" y2="12"/><line x1="4.93" y1="19.07" x2="7.76" y2="16.24"/><line x1="16.24" y1="7.76" x2="19.07" y2="4.93"/></svg>
                        </div>
                        <input 
                            id="modal-food-input"
                            type="text"
                            inputmode="text"
                            enterkeyhint="go"
                            placeholder="Describe food or enter calories..."
                            class="w-full bg-neutral-800 border border-neutral-700 rounded-lg py-3 pl-10 pr-4 text-white outline-none focus:ring-2 focus:ring-amber-500 placeholder-neutral-500 transition-all"
                        >
                    </div>
                    <p id="modal-error-msg" class="hidden text-rose-400 font-bold text-xs px-1"></p>

                    <div class="flex gap-3">
                        <button onclick="closeLogModal()" class="flex-1 py-3 rounded-lg font-bold text-neutral-400 hover:bg-neutral-800 transition-colors">Cancel</button>
                        <button onclick="analyzeFood()" class="flex-1 py-3 rounded-lg font-bold bg-amber-500 text-black hover:bg-amber-400 transition-colors">Log</button>
                    </div>
                </div>
            </div>
        </div>

        <header class="space-y-6">
            <div class="bg-neutral-900/50 backdrop-blur-sm p-6 rounded-xl border border-neutral-800 shadow-2xl">
                <div id="totals-grid" class="flex flex-col md:flex-row gap-6 items-start md:items-center w-full">
                    </div>
            </div>

            <div class="bg-neutral-900 p-6 rounded-xl border border-neutral-800 shadow-xl">
                <div class="flex justify-between items-end mb-3">
                    <h2 class="header-text text-neutral-500 text-xs uppercase tracking-widest">Daily Progress</h2>
                    <button onclick="editGoal()" class="text-xs text-amber-500 hover:text-amber-400 header-text uppercase tracking-widest transition-colors cursor-pointer outline-none">
                        Goal: <span id="goal-display">2000</span>
                    </button>
                </div>
                <div class="w-full bg-neutral-800 rounded-full h-3 overflow-hidden">
                    <div id="progress-bar" class="bg-amber-500 h-full rounded-full transition-all duration-500 ease-out" style="width: 0%"></div>
                </div>
                <div class="mt-2 text-[10px] text-neutral-500 font-bold">
                    <span id="percent-display">0%</span>
                </div>
            </div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <div class="lg:col-span-2 space-y-6">
                <button onclick="openLogModal()" class="w-full bg-neutral-900 p-6 rounded-xl border border-neutral-800 shadow-xl flex items-center justify-between group hover:border-amber-500/50 transition-all cursor-pointer">
                    <div class="flex items-center gap-4">
                        <div class="bg-neutral-800 p-3 rounded-lg text-amber-500 group-hover:bg-amber-500 group-hover:text-black transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                        </div>
                        <div class="text-left">
                            <span class="block header-text text-neutral-200 group-hover:text-white transition-colors text-lg">Log Food</span>
                            <span class="block text-xs text-neutral-500 uppercase tracking-widest group-hover:text-neutral-400">Add Entry to Daily or Library</span>
                        </div>
                    </div>
                </button>

                <section class="bg-neutral-900 rounded-xl border border-neutral-800 overflow-hidden shadow-lg">
                    <div class="p-6 border-b border-neutral-800 bg-neutral-900/50">
                        <h2 class="header-text flex items-center gap-2 text-neutral-500">Today's Log</h2>
                    </div>
                    <div id="log-container" class="divide-y divide-neutral-800 max-h-[500px] overflow-y-auto no-scrollbar">
                    </div>
                </section>
            </div>

            <aside class="bg-neutral-900 rounded-xl border border-neutral-800 h-fit overflow-hidden shadow-lg">
                <div class="p-6 border-b border-neutral-800 bg-neutral-900/50 header-text text-neutral-500">Library</div>
                <div id="library-container" class="p-2 space-y-1 max-h-[500px] overflow-y-auto no-scrollbar">
                </div>
            </aside>
        </div>
    </div>

    <script>
        // ---------------------------------------------------------
        // CONFIGURATION
        // ---------------------------------------------------------
        // Get a free key at: https://aistudio.google.com/app/apikey
        const apiKey = ""; 
        const modelName = "gemini-2.0-flash";
        // ---------------------------------------------------------

        let dailyLog = [];
        let savedItems = [];
        let dailyGoal = 2000;
        let inputMode = 'daily';
        let lastResetDate = "";

        const elements = {
            logModal: document.getElementById('log-modal'),
            modalInput: document.getElementById('modal-food-input'),
            modalTabDaily: document.getElementById('modal-tab-daily'),
            modalTabLibrary: document.getElementById('modal-tab-library'),
            modalError: document.getElementById('modal-error-msg'),
            spinner: document.getElementById('loading-spinner'),
            searchIcon: document.getElementById('search-icon'),
            
            log: document.getElementById('log-container'),
            library: document.getElementById('library-container'),
            stats: document.getElementById('totals-grid'),
            
            goalDisplay: document.getElementById('goal-display'),
            progressBar: document.getElementById('progress-bar'),
            percentDisplay: document.getElementById('percent-display'),
            goalModal: document.getElementById('goal-modal'),
            goalInput: document.getElementById('goal-input')
        };

        function init() {
            const data = JSON.parse(localStorage.getItem('calorie_tracker_data') || '{"log":[],"library":[],"goal":2000,"lastResetDate":""}');
            const today = new Date().toDateString();

            if (data.lastResetDate !== today) {
                dailyLog = [];
                lastResetDate = today;
                localStorage.setItem('calorie_tracker_data', JSON.stringify({
                    ...data,
                    log: [],
                    lastResetDate: today
                }));
            } else {
                dailyLog = data.log || [];
                lastResetDate = data.lastResetDate;
            }

            savedItems = data.library || [];
            dailyGoal = data.goal || 2000;
            
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('./sw.js').catch(() => {});
            }
            render();
        }

        // --- UI Modes ---

        function openLogModal() {
            elements.logModal.classList.remove('hidden');
            elements.modalInput.value = "";
            elements.modalError.classList.add('hidden');
            setTimeout(() => elements.modalInput.focus(), 100);
        }

        function closeLogModal() {
            elements.logModal.classList.add('hidden');
        }

        function setInputMode(mode) {
            inputMode = mode;
            elements.modalTabDaily.className = mode === 'daily' ? 'tab-active pb-1 text-xs header-text uppercase tracking-widest transition-all' : 'tab-inactive pb-1 text-xs header-text uppercase tracking-widest transition-all';
            elements.modalTabLibrary.className = mode === 'library' ? 'tab-active pb-1 text-xs header-text uppercase tracking-widest transition-all' : 'tab-inactive pb-1 text-xs header-text uppercase tracking-widest transition-all';
            elements.modalInput.placeholder = mode === 'daily' ? "Describe food or enter calories..." : "Item to save...";
            elements.modalInput.focus();
        }

        // --- Goal Logic ---

        function editGoal() {
            elements.goalModal.classList.remove('hidden');
            elements.goalInput.value = dailyGoal;
            setTimeout(() => elements.goalInput.focus(), 100);
        }

        function closeGoalModal() {
            elements.goalModal.classList.add('hidden');
        }

        function saveGoalFromModal() {
            const newGoal = parseInt(elements.goalInput.value);
            if (!isNaN(newGoal) && newGoal > 0) {
                dailyGoal = newGoal;
                saveAndRender();
                closeGoalModal();
            }
        }

        // --- Analysis Logic ---

        async function analyzeFood() {
            const text = elements.modalInput.value.trim();
            if (!text) return;

            // 1. Handle direct numbers
            const numeric = parseFloat(text);
            if (!isNaN(numeric) && isFinite(text)) {
                const item = { name: "Manual Entry", calories: numeric, protein: 0, carbs: 0, fat: 0 };
                finalizeItem(item);
                return;
            }

            setLoading(true);

            try {
                // 2. SIMULATION MODE (If no API Key)
                if (!apiKey) {
                    // Small delay to simulate network feel
                    await new Promise(r => setTimeout(r, 600));
                    
                    // Mock logic for testing
                    const mockItem = {
                        name: text,
                        calories: Math.floor(Math.random() * 400) + 100,
                        protein: Math.floor(Math.random() * 30),
                        carbs: Math.floor(Math.random() * 50),
                        fat: Math.floor(Math.random() * 15)
                    };
                    
                    mockItem.name += " (Sim)";
                    finalizeItem(mockItem);
                    return;
                }

                // 3. REAL AI MODE
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${modelName}:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: `Analyze this food: "${text}". Return ONLY valid JSON (no markdown) with keys: name (string), calories (number), protein (number), carbs (number), fat (number). Estimate standard portion if not specified.` }] }],
                        generationConfig: { responseMimeType: "application/json" }
                    })
                });

                if (!response.ok) throw new Error("API Error");

                const data = await response.json();
                const result = JSON.parse(data.candidates[0].content.parts[0].text);
                finalizeItem(result);

            } catch (err) {
                console.error(err);
                elements.modalError.textContent = "Error: Check API Key.";
                elements.modalError.classList.remove('hidden');
            } finally {
                setLoading(false);
            }
        }

        function finalizeItem(item) {
            if (inputMode === 'daily') addLogItem(item);
            else addLibraryItem(item);
            closeLogModal();
        }

        function addLogItem(item) {
            dailyLog.unshift({ ...item, id: Date.now() });
            saveAndRender();
        }

        function addLibraryItem(item) {
            if (!savedItems.find(s => s.name.toLowerCase() === item.name.toLowerCase())) {
                savedItems.unshift({ ...item, id: Date.now() });
            }
            saveAndRender();
        }

        function deleteLog(id) {
            dailyLog = dailyLog.filter(i => i.id !== id);
            saveAndRender();
        }

        function deleteLibrary(id) {
            savedItems = savedItems.filter(i => i.id !== id);
            saveAndRender();
        }

        function saveAndRender() {
            localStorage.setItem('calorie_tracker_data', JSON.stringify({ 
                log: dailyLog, 
                library: savedItems, 
                goal: dailyGoal,
                lastResetDate: lastResetDate 
            }));
            render();
        }

        function setLoading(val) {
            elements.spinner.classList.toggle('hidden', !val);
            elements.searchIcon.classList.toggle('hidden', val);
            elements.modalError.classList.add('hidden');
        }

        function render() {
            const totals = dailyLog.reduce((a, b) => ({
                cal: a.cal + (b.calories || 0),
                p: a.p + (b.protein || 0),
                c: a.c + (b.carbs || 0),
                f: a.f + (b.fat || 0)
            }), { cal: 0, p: 0, c: 0, f: 0 });

            elements.goalDisplay.textContent = dailyGoal;
            const percent = dailyGoal > 0 ? Math.min((totals.cal / dailyGoal) * 100, 100) : 0;
            elements.progressBar.style.width = `${percent}%`;
            elements.percentDisplay.textContent = `${Math.round(percent)}%`;

            elements.stats.innerHTML = `
                <div class="flex-1 border-b md:border-b-0 md:border-r border-neutral-800 pb-4 md:pb-0 pr-0 md:pr-8">
                    <span class="header-text text-neutral-500 text-[11px] uppercase tracking-widest">Total Calories</span>
                    <div class="header-text text-amber-500 text-4xl mt-1 leading-none">${Math.round(totals.cal)}<span class="ml-1 opacity-50 text-neutral-400 font-normal text-xs uppercase">kcal</span></div>
                </div>
                <div class="flex flex-1 flex-wrap gap-8 w-full">
                    ${statCard('Protein', Math.round(totals.p), 'g', 'text-red-500')}
                    ${statCard('Carbs', Math.round(totals.c), 'g', 'text-green-500')}
                    ${statCard('Fat', Math.round(totals.f), 'g', 'text-yellow-500')}
                </div>
            `;

            elements.log.innerHTML = dailyLog.length ? dailyLog.map(item => `
                <div class="p-4 flex items-center justify-between hover:bg-neutral-800/50 transition-colors">
                    <div>
                        <h3 class="header-text text-white capitalize">${item.name}</h3>
                        <p class="text-neutral-500 mt-0.5">${item.calories} kcal • P: ${item.protein}g • C: ${item.carbs}g • F: ${item.fat}g</p>
                    </div>
                    <button onclick="deleteLog(${item.id})" class="p-2 text-neutral-600 hover:text-rose-400 min-h-[44px] min-w-[44px] flex items-center justify-center">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg>
                    </button>
                </div>
            `).join('') : '<div class="p-6 text-neutral-600 text-center text-sm">No entries today</div>';

            elements.library.innerHTML = savedItems.length ? savedItems.map(item => `
                <div class="p-3 rounded-lg hover:bg-neutral-800 flex items-center justify-between group">
                    <div class="flex-1 cursor-pointer" onclick="addLogItem({name:'${item.name.replace(/'/g, "\\'")}',calories:${item.calories},protein:${item.protein},carbs:${item.carbs},fat:${item.fat}})">
                        <p class="header-text capitalize text-neutral-200 group-hover:text-amber-500 transition-colors">${item.name}</p>
                        <p class="text-neutral-500 text-xs">${item.calories} kcal</p>
                    </div>
                    <div class="flex gap-1">
                        <button onclick="addLogItem({name:'${item.name.replace(/'/g, "\\'")}',calories:${item.calories},protein:${item.protein},carbs:${item.carbs},fat:${item.fat}})" class="p-2 text-neutral-600 hover:text-amber-500 min-h-[44px] min-w-[44px] flex items-center justify-center">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                        </button>
                        <button onclick="deleteLibrary(${item.id})" class="p-2 text-neutral-600 hover:text-rose-400 min-h-[44px] min-w-[44px] flex items-center justify-center">
                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
                        </button>
                    </div>
                </div>
            `).join('') : '<div class="p-2 text-neutral-600 text-center text-xs">Library empty</div>';
        }

        function statCard(label, val, unit, colorClass) {
            return `<div class="flex flex-col"><span class="header-text text-neutral-500 text-[10px] uppercase tracking-widest">${label}</span><div class="header-text ${colorClass} mt-1">${val}<span class="ml-0.5 opacity-50 text-neutral-400 font-normal text-[10px]">${unit}</span></div></div>`;
        }

        elements.modalInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') analyzeFood();
        });
        
        elements.goalInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') saveGoalFromModal();
        });

        init();
    </script>
</body>
</html>
